@{
    ViewData["Title"] = "Forgot Password";
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
</head>

<body style="background-color:#f4f6f9;">

    <div class="container d-flex align-items-center justify-content-center"
         style="min-height:100vh;">

        <div class="card shadow"
             style="width:450px; border-radius:10px;">

            <div class="card-body p-5">

                <h4 class="fw-bold text-primary mb-2 text-center">
                    Forgot Password
                </h4>

                <p class="text-muted text-center mb-4">
                    Enter your registered email to receive OTP
                </p>

                <!-- ================= STEP 1 ================= -->
                <div id="stepEmail">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            Email Address
                        </label>
                        <input type="email"
                               id="email"
                               class="form-control"
                               placeholder="name@company.net" />
                    </div>

                    <button type="button"
                            id="btnSendOtp"
                            class="btn w-100"
                            style="background-color:#0d6efd; color:white; font-weight:600; padding:10px; border-radius:6px;"
                            onclick="sendOtp()">
                        Send OTP
                    </button>
                </div>

                <!-- ================= STEP 2 ================= -->
                <div id="stepOtp" style="display:none;">
                    <div class="mb-3 mt-4">
                        <label class="form-label fw-semibold">
                            Enter OTP
                        </label>
                        <input type="text"
                               id="otp"
                               class="form-control"
                               placeholder="6-digit OTP" />
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox"
                               id="confirmCheck"
                               class="form-check-input"
                               onchange="toggleVerifyButton()" />

                        <label class="form-check-label" for="confirmCheck">
                            I confirm this is my account
                        </label>
                    </div>

                    <button type="button"
                            id="btnVerifyOtp"
                            class="btn w-100"
                            style="background-color:#0d6efd; color:white; font-weight:600; padding:10px; border-radius:6px;"
                            onclick="verifyOtp()"
                            disabled>
                        Verify OTP
                    </button>
                </div>

                <div class="text-center mt-3">
                    <small id="resendText" class="text-muted">
                        Resend OTP in <span id="countdown">60</span>s
                    </small>

                    <button type="button"
                            id="btnResend"
                            class="btn btn-link p-0 ms-2"
                            style="display:none;"
                            onclick="resendOtp()">
                        Resend OTP
                    </button>
                </div>

                <!-- ================= STEP 3 ================= -->
                <div id="stepReset" style="display:none;">
                    <div class="mb-3 mt-4">
                        <label class="form-label fw-semibold">
                            New Password
                        </label>
                        <input type="password"
                               id="newPassword"
                               class="form-control"
                               placeholder="Enter new password"
                               onkeyup="checkPasswords()" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            Confirm Password
                        </label>
                        <input type="password"
                               id="confirmPassword"
                               class="form-control"
                               placeholder="Confirm password"
                               onkeyup="checkPasswords()" />

                        <small id="passwordMessage" class="fw-semibold"></small>
                    </div>

                    <button type="button"
                            id="btnReset"
                            class="btn w-100"
                            style="background-color:#0d6efd; color:white; font-weight:600; padding:10px; border-radius:6px;"
                            onclick="resetPassword()"
                            disabled>
                        Update Password
                    </button>
                </div>

                <div class="text-center mt-4">
                    <a asp-controller="Account"
                       asp-action="Login"
                       class="text-decoration-none small text-secondary">
                        ← Back to Login
                    </a>
                </div>

            </div>
        </div>

    </div>

    <!-- ================= JAVASCRIPT ================= -->

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
                function sendOtp() {

            var email = $("#email").val();

            if (!email) {
                alert("Please enter your email.");
                return;
            }

            // Disable button + show spinner
            $("#btnSendOtp")
                .prop("disabled", true)
                .html('<span class="spinner-border spinner-border-sm"></span> Sending...');

            // Show OTP section immediately (better UX)
                   $("#stepEmail").hide();
                   $("#stepOtp").show();
                   startTimer();

            $.post("@Url.Action("SendOtp", "Account")", { email: email }, function (res) {

                if (!res.success) {
                    alert(res.message);
                    $("#stepOtp").hide();
                    $("#stepEmail").show();
                }

                // Restore button
                $("#btnSendOtp")
                    .prop("disabled", false)
                    .html("Send OTP");

            });
        }

        function verifyOtp() {

            var email = $("#email").val();
            var otp = $("#otp").val();

            $.post("/Account/VerifyOtp", { email: email, otp: otp }, function (res) {

                if (res.success) {
                    $("#stepOtp").hide();
                    $("#stepReset").show();
                } else {
                    alert(res.message);
                }

            });
        }

        function resetPassword() {

            var email = $("#email").val();
            var newPassword = $("#newPassword").val();
            var confirmPassword = $("#confirmPassword").val();

            $.post("/Account/ResetPassword",
                {
                    email: email,
                    newPassword: newPassword,
                    confirmPassword: confirmPassword
                },
                function (res) {

                          if (res.success) {

            $("#stepReset").html(`
                <div class="alert alert-success text-center">
                    Password updated successfully.
                </div>
            `);

            setTimeout(function () {
                window.location.href = "/Account/Login";
            }, 1500);
        }
                });
        }

                function checkPasswords() {

            var newPassword = $("#newPassword").val();
            var confirmPassword = $("#confirmPassword").val();

            if (newPassword.length > 0 &&
                confirmPassword.length > 0 &&
                newPassword === confirmPassword) {

                $("#btnReset").prop("disabled", false);

            } else {

                $("#btnReset").prop("disabled", true);
            }
        }

                function checkPasswords() {

            var newPassword = $("#newPassword").val();
            var confirmPassword = $("#confirmPassword").val();
            var message = $("#passwordMessage");

            if (newPassword.length === 0 && confirmPassword.length === 0) {
                message.text("");
                $("#btnReset").prop("disabled", true);
                return;
            }

            if (newPassword === confirmPassword && newPassword.length > 0) {

                message
                    .removeClass("text-danger")
                    .addClass("text-success")
                    .text("✓ Passwords match");

                $("#btnReset").prop("disabled", false);

            } else {

                message
                    .removeClass("text-success")
                    .addClass("text-danger")
                    .text("✗ Passwords do not match");

                $("#btnReset").prop("disabled", true);
            }
        }

                var timerInterval;
        var countdownTime = 60;

        function startTimer() {

            countdownTime = 60;
            $("#countdown").text(countdownTime);
            $("#resendText").show();
            $("#btnResend").hide();

            timerInterval = setInterval(function () {

                countdownTime--;
                $("#countdown").text(countdownTime);

                if (countdownTime <= 0) {
                    clearInterval(timerInterval);
                    $("#resendText").hide();
                    $("#btnResend").show();
                }

            }, 1000);
        }

                function resendOtp() {

            var email = $("#email").val();

            $("#btnResend").prop("disabled", true).text("Sending...");

            $.post("@Url.Action("SendOtp", "Account")", { email: email }, function (res) {

                if (res.success) {
                    startTimer();
                } else {
                    alert(res.message);
                }

                $("#btnResend").prop("disabled", false).text("Resend OTP");

            });
        }

                function toggleVerifyButton() {

            if ($("#confirmCheck").is(":checked")) {
                $("#btnVerifyOtp").prop("disabled", false);
            } else {
                $("#btnVerifyOtp").prop("disabled", true);
            }
        }
    </script>

</body>
</html>