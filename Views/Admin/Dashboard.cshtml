@using Microsoft.AspNetCore.Http

@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    int? roleId = Context.Session.GetInt32("RoleId");
    bool isAdmin = roleId == 1;
}

<!-- HEADER WITH PROFILE ICON -->
<div class="page-accent d-flex justify-content-between align-items-center">
    <h3 class="m-0">Dashboard</h3>

    <div class="dropdown">
        <button class="btn btn-light rounded-circle"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                style="width:45px;height:45px;">
            <i class="bi bi-person-circle fs-4"></i>
        </button>

        <ul class="dropdown-menu dropdown-menu-end shadow p-3" style="width:250px;">

            <li class="mb-2">
                <button class="btn btn-sm btn-outline-primary w-100"
                        data-bs-toggle="modal"
                        data-bs-target="#changePasswordModal">
                    Change Password
                </button>
            </li>

            <li>
                <a class="btn btn-sm btn-outline-danger w-100"
                   asp-controller="Account"
                   asp-action="Logout">
                    Logout
                </a>
            </li>

        </ul>
    </div>
</div>

<div class="row mt-3 g-4">

    @if (isAdmin)
    {
        <div class="col-md-4">

            <a asp-controller="Admin" asp-action="Employees"
               class="text-decoration-none text-dark">
                <div class="card shadow-sm border-0 p-4 dashboard-card pop-card mb-3">
                    <div class="d-flex align-items-center">
                        <div class="me-3 fs-1">👥</div>
                        <div>
                            <h6 class="mb-1">Employees</h6>
                            <h2 class="mb-0">@ViewBag.EmployeeCount</h2>
                        </div>
                    </div>
                </div>
            </a>

            <a asp-controller="Admin" asp-action="Roles"
               class="text-decoration-none text-dark">
                <div class="card shadow-sm border-0 p-4 dashboard-card pop-card">
                    <div class="d-flex align-items-center">
                        <div class="me-3 fs-1">🏷️</div>
                        <div>
                            <h6 class="mb-1">Roles</h6>
                            <h2 class="mb-0">@ViewBag.RoleCount</h2>
                        </div>
                    </div>
                </div>
            </a>

        </div>

        <div class="col-md-8">
            <div class="card shadow-sm border-0 dashboard-card p-3">
                <h4 class="text-center mb-3">📅 Calendar</h4>
                <div id="calendar"></div>
            </div>
        </div>
    }
    else
    {
        <div class="col-md-12">
            <div class="card shadow-sm border-0 dashboard-card p-3">
                <h4 class="text-center mb-3">📅 Calendar</h4>
                <div id="calendar"></div>
            </div>
        </div>
    }

</div>

<!-- CHANGE PASSWORD MODAL -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Change Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form asp-controller="Account"
                  asp-action="ChangePassword"
                  method="post">
                @Html.AntiForgeryToken()

                <div class="modal-body">

                    <div class="mb-3">
                        <label class="form-label">Current Password</label>
                        <input type="password"
                               name="currentPassword"
                               class="form-control"
                               required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">New Password</label>
                        <input type="password"
                               name="newPassword"
                               class="form-control"
                               required />
                    </div>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary w-100">
                        Update Password
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>

<script>
    const holidayDates = [
        @if (ViewBag.Holidays != null)
        {
                foreach (DateTime date in ViewBag.Holidays)
                {
                        @:new Date("@date.ToString("yyyy-MM-dd")"),
                }
        }
    ];

    const leaveDates = [
        @if (ViewBag.ApprovedLeaveDates != null)
        {
                foreach (DateTime date in ViewBag.ApprovedLeaveDates)
                {
                        @:new Date("@date.ToString("yyyy-MM-dd")"),
                }
        }
    ];

    function isHoliday(day, month, year) {
        return holidayDates.some(d =>
            d.getDate() === day &&
            d.getMonth() === month &&
            d.getFullYear() === year
        );
    }

    function isLeave(day, month, year) {
        return leaveDates.some(d =>
            d.getDate() === day &&
            d.getMonth() === month &&
            d.getFullYear() === year
        );
    }

    function generateCalendar() {
        const calendar = document.getElementById("calendar");
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        let html = `<div class="text-center fw-bold mb-3 fs-5">
                        ${monthNames[month]} ${year}
                    </div>`;

        html += `<div class="calendar-grid">`;

        const weekDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        weekDays.forEach(d => {
            html += `<div class="calendar-header">${d}</div>`;
        });

        for (let i = 0; i < firstDay; i++) {
            html += `<div></div>`;
        }

        for (let day = 1; day <= daysInMonth; day++) {

            const isToday = day === today.getDate();
            const holiday = isHoliday(day, month, year);
            const leave = isLeave(day, month, year);

            let tooltip = "";

            if (leave) {
                tooltip = "You have approved leave on this day";
            } else if (holiday) {
                tooltip = "Holiday";
            }

            html += `<div class="calendar-day
                        ${isToday ? "today" : ""}
                        ${holiday ? "holiday" : ""}
                        ${leave ? "leave" : ""}"
                        title="${tooltip}">
                        ${day}
                     </div>`;
        }

        html += `</div>`;
        calendar.innerHTML = html;
    }

    generateCalendar();
</script>