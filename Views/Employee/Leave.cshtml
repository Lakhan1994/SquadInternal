@model List<SquadInternal.Models.EmployeeLeave>
@{
    ViewData["Title"] = "My Leaves";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="page-accent d-flex justify-content-between align-items-center">
    <h3>My Leaves</h3>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#applyLeaveModal">
        + Apply Leave
    </button>
</div>

<div class="card shadow-sm border-0 mt-3">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Type</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var leave in Model)
                {
                    string badgeClass = leave.Status == "Approved" ? "bg-success"
                    : leave.Status == "Pending" ? "bg-warning text-dark"
                    : leave.Status == "Cancelled" ? "bg-secondary"
                    : "bg-danger";

                    <tr>
                        <td>@leave.LeaveType</td>
                        <td>@leave.FromDate.ToString("dd MMM yyyy")</td>
                        <td>@leave.ToDate.ToString("dd MMM yyyy")</td>
                        <td>
                            <span class="badge @badgeClass">
                                @leave.Status
                            </span>
                        </td>
                        <td>
                            @if (leave.Status == "Pending")
                            {
                                <form asp-action="CancelLeave" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@leave.Id" />
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        Backout
                                    </button>
                                </form>
                            }
                            else
                            {
                                <span class="text-muted">—</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- APPLY LEAVE MODAL -->
<div class="modal fade" id="applyLeaveModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="leaveForm">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title">Apply Leave</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <div class="mb-3">
                        <label>Leave Type</label>
                        <select name="LeaveType" class="form-control">
                            <option>Sick Leave</option>
                            <option>Casual Leave</option>
                            <option>Half Day</option>
                            <option>Paternity Leave</option>
                            <option>Maternity Leave</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label>From Date</label>
                        <input type="date" name="FromDate" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label>To Date</label>
                        <input type="date" name="ToDate" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label>Reason</label>
                        <textarea name="Reason" class="form-control" required></textarea>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">
                        Apply
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    document.getElementById("leaveForm").addEventListener("submit", async function (e) {

        e.preventDefault();

        const formData = new FormData(this);

        const response = await fetch("/Employee/ApplyLeave", {
            method: "POST",
            body: formData
        });

        const result = await response.json();

        if (!result.success) {
            toastr.error(result.message);   
        } else {
            toastr.success(result.message);
            setTimeout(() => location.reload(), 1500);
        }
    });
</script>
